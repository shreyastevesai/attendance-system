<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Work Hour Tracker</title>

<style>
body{
    font-family: Poppins, Arial, sans-serif;
    background:#eef3f9;
    padding:20px;
}
h2{
    text-align:center;
    margin-bottom:20px;
}
table{
    width:100%;
    border-collapse:collapse;
    background:white;
}
th,td{
    border:1px solid #bbb;
    padding:6px;
    text-align:center;
}
.off{
    background:#ffdada;
}
.work{
    background:#eaffea;
}
.green{color:green;font-weight:600;}
.red{color:red;font-weight:600;}
.orange{color:orange;font-weight:600;}
input,select{
    padding:3px;
    text-align:center;
    width:58px;
}
.logout-btn{
    background:#ff4b4b;color:white;border:none;
    padding:8px 14px;border-radius:10px;cursor:pointer;
    float:right;margin-bottom:10px;font-weight:600;
}
.logout-btn:hover{
    opacity:0.8;
}
</style>
</head>

<body>

<button class="logout-btn" onclick="window.location='/logout'">Logout</button>
<h2>Attendance Sheet — <span id="monthTitle"></span></h2>

<table>
    <thead>
        <tr>
            <th>Date</th>
            <th>Day</th>
            <th>Punch In</th>
            <th>Punch Out</th>
            <th>Worked</th>
            <th>Today +/-</th>
            <th>Weekly Balance</th>
        </tr>
    </thead>
    <tbody id="rows"></tbody>
</table>


<script>
/* -------------- MONTH RECEIVED FROM BACKEND ---------------- */
const SELECTED_MONTH = "{{ month }}";  // Format: YYYY-MM

/* -------------- MONTH TITLE DISPLAY ---------------- */
document.getElementById("monthTitle").innerText =
    new Date(SELECTED_MONTH + "-01").toLocaleDateString("en-US",
       {month:"long", year:"numeric"}
    );

/* Daily Target = 9 hours */
const TARGET_MIN = 9 * 60;

/* Format date as: 02-Dec-2025 */
function formatDateDisplay(d){
    const dd = String(d.getDate()).padStart(2,'0');
    const mon = d.toLocaleDateString("en-US",{month:"short"});
    const yr = d.getFullYear();
    return `${dd}-${mon}-${yr}`;
}

/* -------------------- BUILD MONTHLY TABLE -------------------- */
function buildTable(){
    const rows = document.getElementById("rows");

    let [year, mon] = SELECTED_MONTH.split("-");
    mon = parseInt(mon) - 1;

    let d = new Date(year, mon, 1);
    const end = new Date(year, mon + 1, 0);

    while(d <= end){
        const displayDate = formatDateDisplay(d);
        const key = d.toISOString().split("T")[0];
        const dayName = d.toLocaleDateString("en-US", {weekday:"long"});
        const isOff = (dayName === "Saturday" || dayName === "Sunday");

        rows.insertAdjacentHTML("beforeend", `
<tr class="${isOff ? "off" : "work"}">
    <td data-key="${key}">${displayDate}</td>
    <td>${dayName}</td>

    <td>
      ${isOff ? "-" : `
        <input class="inH" type="number" min="1" max="12" value="10"> :
        <input class="inM" type="number" min="0" max="59" value="30">
        <select class="inAP">
            <option selected>AM</option>
            <option>PM</option>
        </select>
      `}
    </td>

    <td>
      ${isOff ? "-" : `
        <input class="outH" type="number" min="1" max="12" value="7"> :
        <input class="outM" type="number" min="0" max="59" value="30">
        <select class="outAP">
            <option>AM</option>
            <option selected>PM</option>
        </select>
      `}
    </td>

    <td id="w_${key}">-</td>
    <td id="d_${key}">-</td>
    <td id="b_${key}">-</td>
</tr>
        `);

        d.setDate(d.getDate() + 1);
    }
}


/* ------------ Convert AM/PM time into minutes ------------ */
function toMinutes(h, m, ap){
    h = parseInt(h);
    m = parseInt(m);

    if (ap === "PM" && h !== 12) h += 12;
    if (ap === "AM" && h === 12) h = 0;

    return h * 60 + m;
}


/* ----------- UPDATE ROW WHEN USER ENTERS VALUES ---------- */
function updateRow(tr){
    const key = tr.children[0].dataset.key;
    const inH = tr.querySelector(".inH");
    if (!inH) return;

    const inM  = tr.querySelector(".inM");
    const inAP = tr.querySelector(".inAP");
    const outH = tr.querySelector(".outH");
    const outM = tr.querySelector(".outM");
    const outAP= tr.querySelector(".outAP");

    const start = toMinutes(inH.value, inM.value, inAP.value);
    let end     = toMinutes(outH.value, outM.value, outAP.value);

    if (end < start) end += 24 * 60; // Next day logic

    const workMin = end - start;
    const hh = Math.floor(workMin / 60);
    const mm = workMin % 60;

    document.getElementById("w_" + key).innerText =
        `${hh}h ${String(mm).padStart(2,'0')}m`;

    // Save to server
    const payload = {
        date: key,
        hours: workMin / 60,
        inH: inH.value, inM: inM.value, inAP: inAP.value,
        outH: outH.value, outM: outM.value, outAP: outAP.value
    };

    fetch("/save", {
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify(payload)
    }).then(()=> loadData());
}


/* -------------------- LOAD SAVED DATA -------------------- */
function loadData(){
    fetch("/load")
    .then(r=>r.json())
    .then(res=>{
        const data = res.data || {};
        const keys = Object.keys(data).sort();

        let weekBalanceMin = 0;

        keys.forEach(key=>{
            const rec = data[key];
            const totalMinutes = Math.round(rec.hours * 60);

            const row = document.querySelector(`td[data-key='${key}']`)?.parentElement;
            if (!row) return;

            const wCell = document.getElementById("w_" + key);
            const dCell = document.getElementById("d_" + key);
            const bCell = document.getElementById("b_" + key);

            const dt = new Date(key);
            const wd = dt.getDay();

            const inH  = row.querySelector(".inH");
            if (inH) {
                inH.value = rec.inH;
                row.querySelector(".inM").value = rec.inM;
                row.querySelector(".inAP").value = rec.inAP;
                row.querySelector(".outH").value = rec.outH;
                row.querySelector(".outM").value = rec.outM;
                row.querySelector(".outAP").value = rec.outAP;
            }

            // Trigger auto-calculation for every loaded row
            updateRow(row);
        });
    });
}


/* -------------- HARD LOCK MINUTES INPUT TO 0–59 ---------------- */
document.addEventListener("input", e=>{
    if (e.target.classList.contains("inM") ||
        e.target.classList.contains("outM")){
        
        let v = parseInt(e.target.value);

        if (v > 59) e.target.value = 59;
        if (v < 0 || isNaN(v)) e.target.value = 0;
    }
});


/* -------------- WHEN ANY FIELD CHANGES → UPDATE ROW -------------- */
document.addEventListener("change", e=>{
    if (e.target.matches("input,select")){
        const tr = e.target.closest("tr");
        if (tr) updateRow(tr);
    }
});


/* -------------- INITIALIZE PAGE -------------- */
buildTable();
setTimeout(loadData, 300);

</script>

</body>
</html>
