<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Attendance Sheet</title>

<style>
body{
    font-family: Poppins, Arial;
    background:#eef3f9;
    padding:20px;
}
h2{
    text-align:center;
    margin-bottom:20px;
    font-weight:600;
}

table{
    width:100%;
    border-collapse:collapse;
    background:white;
    border-radius:10px;
    overflow:hidden;
    box-shadow:0 3px 10px rgba(0,0,0,0.1);
}

th{
    background:#5a8dee;
    color:white;
    padding:10px;
    font-size:15px;
}

td{
    padding:8px;
    border-bottom:1px solid #ddd;
    text-align:center;
    font-size:14px;
}

tr:last-child td{
    border-bottom:none;
}

.work{background:#eaffea;}
.off {background:#ffe5e5;}

.green{color:green;font-weight:600;}
.red{color:red;font-weight:600;}
.orange{color:orange;font-weight:600;}

input{
    width:45px;
    padding:5px;
    border-radius:6px;
    border:1px solid #bbb;
}
select{
    padding:5px;
    border-radius:6px;
    border:1px solid #bbb;
}

.logout-btn{
    float:right;
    background:#ff4b4b;
    border:none;
    padding:10px 18px;
    color:white;
    border-radius:8px;
    cursor:pointer;
    font-weight:600;
}
</style>
</head>

<body>

<button class="logout-btn" onclick="window.location='/logout'">Logout</button>
<h2>Attendance Sheet â€” <span id="monthTitle"></span></h2>

<table>
<thead>
<tr>
<th>Date</th>
<th>Day</th>
<th>Punch In</th>
<th>Punch Out</th>
<th>Worked</th>
<th>Today +/-</th>
<th>Weekly Balance</th>
</tr>
</thead>
<tbody id="rows"></tbody>
</table>


<script>
/* Month Title */
const SELECTED_MONTH="{{ month }}";

document.getElementById("monthTitle").innerText =
  new Date(SELECTED_MONTH+"-01").toLocaleDateString("en-US",
     {month:"long", year:"numeric"}
  );

const TARGET = 540; // 9h = 540 minutes

/* Format date */
function fmt(d){
    return `${String(d.getDate()).padStart(2,'0')}-${d.toLocaleString("en",{month:"short"})}-${d.getFullYear()}`
}

/* Build table rows */
function buildTable(){
    let [y,m]=SELECTED_MONTH.split("-");
    m--;
    let d=new Date(y,m,1);
    let end=new Date(y,m+1,0);
    let rows=document.getElementById("rows");

    while(d<=end){
        let key=d.toISOString().split("T")[0];
        let day=d.toLocaleDateString("en",{weekday:"long"});
        let off=(day==="Saturday"||day==="Sunday");

rows.insertAdjacentHTML("beforeend",`
<tr class="${off?'off':'work'}">
<td data-key="${key}">${fmt(d)}</td>
<td>${day}</td>

<td>${off?'-':`
  <input class="inH" value="10"> :
  <input class="inM" value="30">
  <select class="inAP">
    <option selected>AM</option>
    <option>PM</option>
  </select>
`}</td>

<td>${off?'-':`
  <input class="outH" value="7"> :
  <input class="outM" value="30">
  <select class="outAP">
    <option>AM</option>
    <option selected>PM</option>
  </select>
`}</td>

<td id="w_${key}">-</td>
<td id="t_${key}">-</td>
<td id="b_${key}">-</td>
</tr>
`);

        d.setDate(d.getDate()+1);
    }
}

/* Convert to minutes */
function toMin(h,m,ap){
    h=parseInt(h); m=parseInt(m);
    if(ap==="PM" && h!==12) h+=12;
    if(ap==="AM" && h===12) h=0;
    return h*60+m;
}

/* Save */
function save(key, mins){
    fetch("/save",{
        method:"POST",
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({date:key, hours:mins/60})
    });
}

/* FULL RECALC */
function recalc(data){
    let week=0;

    Object.keys(data).sort().forEach(key=>{
        let rec=data[key];
        let mins=Math.round(rec.hours*60);

        let td=document.querySelector(`td[data-key='${key}']`);
        if(!td) return;
        let row=td.parentElement;

        let day=row.children[1].innerText;
        let w=document.getElementById("w_"+key);
        let t=document.getElementById("t_"+key);
        let b=document.getElementById("b_"+key);

        /* Worked */
        w.innerText=`${Math.floor(mins/60)}h ${String(mins%60).padStart(2,'0')}m`;

        if(day==="Saturday"||day==="Sunday"){
            t.innerText="-"; b.innerText="-"; return;
        }

        let diff=mins - TARGET;

        /* Today +/- */
        if(diff<0){ t.innerText=`-${(-diff/60|0)}h ${(-diff%60)}m`; t.className="red"; }
        else if(diff>0){ t.innerText=`+${diff/60|0}h ${diff%60}m`; t.className="green"; }
        else { t.innerText="0h 00m"; t.className="orange"; }

        /* WEEK START on Monday */
        if(day==="Monday") week=diff;
        else week+=diff;

        /* Weekly Balance */
        let abs=Math.abs(week);
        b.innerText=`${week<0?'-':'+'}${abs/60|0}h ${abs%60}m`;
        b.className=week<0?"red":"green";
    });
}

function loadData(){
    fetch("/load")
        .then(r=>r.json())
        .then(res=>recalc(res.data||{}));
}

/* Update on edit */
document.addEventListener("change",e=>{
    if(!e.target.closest("tr")) return;
    let tr=e.target.closest("tr");
    let key=tr.children[0].dataset.key;

    let inH=tr.querySelector(".inH"); if(!inH) return;
    let inM=tr.querySelector(".inM");
    let inAP=tr.querySelector(".inAP");
    let outH=tr.querySelector(".outH");
    let outM=tr.querySelector(".outM");
    let outAP=tr.querySelector(".outAP");

    let start=toMin(inH.value,inM.value,inAP.value);
    let end=toMin(outH.value,outM.value,outAP.value);
    if(end<start) end+=1440;

    let mins=end-start;

    document.getElementById("w_"+key).innerText=
        `${Math.floor(mins/60)}h ${String(mins%60).padStart(2,'0')}m`;

    save(key, mins);
    loadData();
});

/* init */
buildTable();
setTimeout(loadData,300);
</script>

</body>
</html>
